## 总览

* 现有断言工具与用例总体合理，能覆盖视图/后缀表存在性、定义包含、基本可查询与行数校验。

* 仍有若干用例的断言与目标不完全匹配或覆盖不足，建议补充失败信息校验、后缀表状态校验与可查询性校验，提升稳健性与准确性。

## 主要问题与改进点

* 04\_rollback 未校验后缀表移除，建议增加 `assert_sr_table_not_exists` 以匹配“后缀表重命名回基础名”的目标。

* 06\_invalid\_mapping 仅以“成功/失败”判断，未验证受影响对象（如 `dns_log`）的视图状态与可查询性，建议补全存在性与查询断言。

* 07\_rename\_conflict 未校验具体错误信息，建议使用 `assert_cmd_fail_contains` 精确匹配“重命名冲突”语义。

* 03\_update\_without\_data 与 12\_partial\_init\_all\_existing\_views 未校验视图可查询；10\_update\_bigint\_type 成功路径也未校验可查询与失败信息。

* 08\_update\_param\_errors 仅覆盖缺失 `--pair` 与类型不符，建议补充缺失 `--table`、缺失 `--partition` 的错误信息断言。

## 具体修改清单

* 用例 04（tests/cases/04\_rollback.sh）

  * 增加：`assert_sr_table_not_exists "${BASE_NAME}${SR_SUFFIX}"` 以确保后缀表去除（参考 tests/helpers/asserts.sh:34-41）。

* 用例 06（tests/cases/06\_invalid\_mapping.sh）

  * 增加：`assert_sr_view_exists "dns_log"`、`assert_sr_view_select_ok "dns_log"`，必要时校验关键列 `assert_sr_describe_contains`（参考 tests/helpers/asserts.sh:76-85, 142-150, 133-140）。

* 用例 07（tests/cases/07\_rename\_conflict.sh）

  * 调整为使用 `assert_cmd_fail_contains "cksr rollback --config ./config.json" "重命名|rename|冲突"` 精确校验失败语义（参考 tests/helpers/asserts.sh:174-187）。

* 用例 03（tests/cases/03\_update\_without\_data.sh）

  * 增加：`assert_sr_view_select_ok "${BASE_NAME}"`，确保即便默认分界也可查询。

* 用例 12（tests/cases/12\_partial\_init\_all\_existing\_views.sh）

  * 增加：对所有补齐视图执行业务最小查询 `assert_sr_view_select_ok`；可选补充后缀表存在性 `assert_sr_table_exists`。

* 用例 10（tests/cases/10\_update\_bigint\_type.sh）

  * 成功路径：增加 `assert_sr_view_select_ok`；失败路径：增加 `assert_cmd_fail_contains`，匹配“类型不符/ALTER VIEW 失败”。

* 用例 08（tests/cases/08\_update\_param\_errors.sh）

  * 补充：缺失 `--table` 与缺失 `--partition` 的错误断言，沿用当前 A/B 结构并匹配具体错误码/提示。

## 断言工具（可选微调）

* 维持现有 `sr_view_exists`/`sr_table_exists`/`sr_show_create_view_contains` 行为；若后续发现兼容问题，再针对 `SHOW FULL TABLES`/`SHOW CREATE VIEW` 的解析做增强（tests/helpers/asserts.sh:13-26, 97-108）。

## 验证步骤

* 逐用例执行 `tests/run_all.sh`，确认所有新增断言通过；出现失败时按错误信息修正期望值或实现。

## 预期产出

* 覆盖增强后的用例集，能更精确地验证“初始化/更新/回滚”各路径的正确性，并对错误场景给出稳定的语义匹配。

